# OpenAPI Implementation Guide

### Prerequisites

- OpenAPI Specification v3.0.3
  
  http://spec.openapis.org/oas/v3.0.3
  
- [OpenAPI Setup Guide](openapi_setup_guide.md) 
  
  This guide assumes that you have set up the project by
  following the OpenAPI setup guide linked above.
- OpenAPI codegen and OpenAPI codegen cli:
  
  https://github.com/OpenAPITools/openapi-generator#17---npm

**IMPORTANT**

#### The project uses machine generated code:
- DO NOT modify the machine generated code, unless it's specified
  that can be modified.
- The front-end SDK library is downloaded from SwaggerHub
- The back-end server library is generated by `OpenAPI Generator cli`
  https://www.npmjs.com/package/@openapitools/openapi-generator-cli

#### You should not modify any of the following machine generated code:

***[If the OpenAPI specs file has been changed, the following code
need to be replaced, using the codegen cli auto-generated code.
Other than updating them manually.]***

- Anything in `express/controllers/` folder, except for `generatePdfReport` function
  in `express/controllers/PublicController.js`. You need to retain or merge this function
  if you generated server libs again.

  For details about the PDF report controller
  override please refer to this commit:

  [4c56f6d95af](https://bitbucket-students.deakin.edu.au/projects/DCVENT-PG/repos/asd-essential-eight-cyber-mitigation-toolkit_2020t3/commits/4c56f6d95afcf330b83ca6274add597102131f9f)
- Anything in `express/utils/` folder
- `express/config.js`
- `express/expressServer.js` except for `validateNodeEnvVersion` function and its
  required libs. For further reference please check this commit:
  [0be00d85e75](https://bitbucket-students.deakin.edu.au/projects/DCVENT-PG/repos/asd-essential-eight-cyber-mitigation-toolkit_2020t3/commits/0be00d85e7504571a2b8bc13c658789f3dee81a6)

- `express/index.js`
- `express/logger.js`

### How to update machine generated code

1. Update the `express/api/openapi.yaml` file.
  
   **This file should be only edited in an OAS editor like SwaggerHub
   editor or Stoplight.io editor that has OAS schema validation.**
   
   Once the editing is done, copy it back to your project
   `express/api/` folder.

2. In your terminal, cd to the `express` folder.
   
3. Run `npm run openapi-gen-server`

   This command definition is in `express/package.json`. When you
run this command it actually runs:
   
   `openapi-generator-cli generate -g nodejs-express-server -i ./api/openapi.yaml -o ./openapi/codegen/server`

   Command args:
   
   `nodejs-express-server` is the codegen template  used.
   
   `-i ./api/openapi.yaml` specifies the OAS specs file.
   
   `-o ./openapi/codegen/server` specifies the output folder.

4. The generated nodejs express server code can be found from
   `express/openapi/codegen/server`

5. Copy the files from `express/openapi/codegen/server/` and
   replace the ones under `express` folder as below:
   
**Note: You should compare the code before and after to find out the custom code.
See the above file list instructions about special cases.**

    - Copy all JavaScript files in
      `express/openapi/codegen/server/controllers/` to
      `express/controllers/` folder, replace existing ones.
    - Move all JavaScript files in `express/openapi/codegen/server/utils/`
      to `express/utils/` folder, replace existing ones.
    - Copy `express/openapi/codegen/server/config.js` and replace
      `express/config.js`
    - Copy `express/openapi/codegen/server/expressServer.js` and
      replace `express/expressServer.js`
    - Copy `express/openapi/codegen/server/express/index.js` and
      replace `express/index.js`
    - Copy `express/openapi/codegen/server/logger.js` and replace
      `express/logger.js`

### The structure of Codegen files

- `express/controllers/` Controller lib files.
- `express/utils/` Utility lib files.
- `express/config.js` Config file.
- `express/expressServer.js` Express server lib.
- `express/index.js` This is the application entry file.
- `express/logger.js` Logger lib.

### Add an Express Route

If you added a new endpoint, you'll need to generate the back-end
server libs again. Besides, you'll require a new route for it to
connect it to the controller. The route is handled automatically,
you don't have to update the route anywhere, just add a route file
to the `express/routes` folder.

Below is an example to explain how you can add a route.

We have an endpoint `/questions` with the following OpenAPI
endpoint definition:

```yaml
  /questions:
    get:
      tags:
        - public
      operationId: getAllQuestions
      x-eov-operation-id: getAllQuestions
      x-eov-operation-handler: routes/getAllQuestions
      summary: Get all questions
```

This line
`x-eov-operation-handler: routes/getAllQuestions`
specified that it needs a route `routes/getAllQuestions`.

So it requires a route file `getAllQuestions.js` in `routes`, after
you added the file it'll look like this `routes/getAllQuestions.js`.

The content of this `routes/getAllQuestions.js` file will look
like this:

```javascript
const { PublicController } = require('../controllers/index')

module.exports = {
  // the express handler implementation for getAllQuestions handler.
  getAllQuestions: PublicController.getAllQuestions
}
```

It specifies which controller function the route should use.

### Referencing Controllers

The auto-generated controllers are called by the routes.

Depending on its tag `public` or `admin`, its auto-generated
route controller definition can be found in
`express/controllers/PublicController.js` or
`express/controllers/AdminsController.js`, and these controllers
are exported in `express/controllers/index.js` file. 

We only need to reference it in routes file using `require`, check
`routes/getAllQuestions.js` file for the example. 

If it's with `public` tag, reference it like this:

`const { PublicController } = require('../controllers/index')`

Otherwise, if it's with admin tag, then reference it like this:

`const { AdminsController } = require('../controllers/index')`

### Add Back-end Services

The controllers in `express/controller` folder are consuming the
services defined in `express/services` folder.

This is the only place you should add your back-end logic to do
things and return the result to the controller.

You can find the auto-generated base function from:

`express/openapi/codegen/server/services/PublicService.js`

and

`express/openapi/codegen/server/services/AdminsService.js`

We then move these service function to separated files in

`express/services/public` and `express/services/admin` folders.

And export these functions from `express/services/index.js`
using `express/services/AdminsService.js`
and `express/services/AdminsService.js` files.

### Example adding a service

We use `/questions` endpoint as an example again.

It has the following OpenAPI endpoint definition:

```yaml
  /questions:
    get:
      tags:
        - public
      operationId: getAllQuestions
      x-eov-operation-id: getAllQuestions
      x-eov-operation-handler: routes/getAllQuestions
      summary: Get all questions
```

Its auto-generated scaffolding function `getAllQuestions` can be
found from:

`express/openapi/codegen/server/services/PublicService.js`

The auto-generated service function is like below:

```javascript
const getAllQuestions = () => new Promise(
  async (resolve, reject) => {
    try {
      resolve(Service.successResponse({
      }));
    } catch (e) {
      reject(Service.rejectResponse(
        e.message || 'Invalid input',
        e.status || 405,
      ));
    }
  },
);
```

Since it has a `public` tag, we'll need to add a service file for
it in `express/services/public` folder: `getAllQuestions.js`, so
it'll look like `express/services/public/getAllQuestions.js`

Then copy the auto-generated function to this
`express/services/public/getAllQuestions.js` file.

Then export it using module export statement:

`module.exports = getAllQuestions`

We import and then export all the public services again from
`express/services/PublicService.js` file.

To implement the logic, edit `express/services/public/getAllQuestions.js`
file:

```javascript
const getAllQuestions = () => new Promise(
  async (resolve, reject) => {
    try {
      resolve(Service.successResponse({
      }));
    } catch (e) {
      reject(Service.rejectResponse(
        e.message || 'Invalid input',
        e.status || 405,
      ));
    }
  },
);
```

Add logic to the try block:

```javascript
try {
  // Add your logic here to query the database, or run
  // calculation, etc. Then pass the result to { payload } object.
  resolve(Service.successResponse({ payload }));
} ...
```

Then pass whatever result it returns to `{ payload }` object to the
`successResponse` function, it'll be passed back to the controller as
the HTTP response data.

You now have added the service. 
